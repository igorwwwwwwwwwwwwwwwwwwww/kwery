#!/usr/bin/env ruby

$: << 'lib'

require 'kwery'

schema = Kwery::Schema.new

schema.import_csv(:users, 'data/users.csv', { id: :integer, active: :boolean })
schema.create_index(:users, :users_idx_id, [
  Kwery::Index::IndexedExpr.new(Kwery::Expr::Column.new(:id), :asc),
])

schema.import_json(:clickhouse_users, 'data/clickhouse_users.json')
schema.create_index(:clickhouse_users, :clickhouse_users_idx_id, [
  Kwery::Index::IndexedExpr.new(Kwery::Expr::Column.new(:id), :asc),
])
schema.create_index(:clickhouse_users, :clickhouse_users_idx_guid, [
  Kwery::Index::IndexedExpr.new(Kwery::Expr::Column.new(:guid), :asc),
])
schema.create_index(:clickhouse_users, :clickhouse_users_idx_name, [
  Kwery::Index::IndexedExpr.new(Kwery::Expr::Column.new(:name), :asc),
])

sql = ARGV.shift

unless sql
  puts 'Usage:'
  puts '  bin/kwery <sql>'
  exit 1
end

options = {}
options[:notablescan] = true if ENV['NOTABLESCAN'] == 'true'

parser = Kwery::Parser.new(options)
query = parser.parse(sql, ENV['DEBUG_PARSER'] == 'true')

plan = query.plan(schema)

context = Kwery::Executor::Context.new(schema)
plan.call(context).each do |tup|
  if tup[:_pretty]
    tup.delete(:_pretty)
    pp tup
  else
    puts tup
  end
end

if ENV['DEBUG_STATS'] == 'true'
  puts
  puts "stats: #{context.stats}"
end
